<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTP Request Web App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .error-message {
            color: red;
            margin-top: 20px;
        }
        .success-message {
            color: green;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Send HTTP Request</h1>
    <form id="paymentForm">
        <div class="form-group">
            <label for="amount">Amount</label>
            <input type="number" id="amount" name="amount" required>
        </div>
        <button type="button" onclick="sendRequest()">Deposit</button>
    </form>

    <div id="responseContainer"></div>

    <script>
        function sendRequest() {
            const amount = document.getElementById('amount').value;
            const url = 'https://eo2uig59l8rs3n8.m.pipedream.net';  // Pipedream URL
            const requestBody = `<?xml version="1.0" encoding="UTF-8"?>
<payment_transaction>
    <transaction_type>sale</transaction_type>
    <transaction_id>${Date.now()}</transaction_id>
    <moto>False</moto>
    <crypto>False</crypto>
    <remote_ip>92.247.243.134</remote_ip>
    <amount>${amount}</amount>
    <currency>USD</currency>
    <card_holder>Tony Stoyánov</card_holder>
    <card_number>4200000000000000</card_number>
    <exp_month>12</exp_month>
    <exp_year>2028</exp_year>
    <cvv>123</cvv>
    <customer_phone>5555555555</customer_phone>
    <customer_email>tony.stoyanov@gmail.com</customer_email>
    <billing_address>
        <first_name>Tony</first_name>
        <last_name>Stoyánov</last_name>
        <address>11 Calle del Sol</address>
        <city>Tulum</city>
        <state>Quintana Roo</state>
        <zip>77760</zip>
        <country>MX</country>
    </billing_address>
</payment_transaction>`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/xml',
                },
                body: requestBody,
            })
            .then(response => {
                if (response.ok) {
                    // Check if the response is XML or plain text
                    const contentType = response.headers.get('Content-Type');
                    if (contentType && contentType.includes('application/xml')) {
                        return response.text();  // Parse the XML text
                    } else {
                        return response.text();  // Treat as plain text
                    }
                } else {
                    throw new Error('Network response was not ok.');
                }
            })
            .then(data => {
                // Log the raw response to inspect its structure
                console.log('Raw Response:', data);

                // Check if the response is in XML format
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data, 'text/xml');

                // Check if there are any XML parsing errors
                const parserErrors = xmlDoc.getElementsByTagName('parsererror');
                if (parserErrors.length > 0) {
                    console.error('XML Parsing Error:', parserErrors[0].textContent);
                    document.getElementById('responseContainer').innerHTML = `<div class="error-message">Error: Invalid XML format.</div>`;
                    return;
                }

                // Handle the response based on XML content
                const statusElement = xmlDoc.getElementsByTagName('status')[0];
                const messageElement = xmlDoc.getElementsByTagName('message')[0];

                if (statusElement && messageElement) {
                    const status = statusElement.textContent;
                    const message = messageElement.textContent;

                    if (status === 'error') {
                        document.getElementById('responseContainer').innerHTML = `<div class="error-message">${message}</div>`;
                    } else {
                        document.getElementById('responseContainer').innerHTML = `<div class="success-message">${message}</div>`;
                    }
                } else {
                    // Handle case when XML structure is unexpected
                    console.error('Unexpected XML response structure:', xmlDoc);
                    document.getElementById('responseContainer').innerHTML = `<div class="error-message">Error: Unexpected response format.</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('responseContainer').innerHTML = `<div class="error-message">Error: Unable to process request.</div>`;
            });
        }
    </script>
</body>
</html>
